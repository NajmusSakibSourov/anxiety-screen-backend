<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnxietyScreen Chatbot</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: #f4f7f6;
            --chat-bg: #ffffff;
            --user-msg-bg: #667eea;
            --bot-msg-bg: #e9ecef;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        .chat-container {
            width: 100%;
            max-width: 480px;
            background: var(--chat-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lang-switch {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background-color: var(--bot-msg-bg);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background-color: var(--user-msg-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .option-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .hidden {
            display: none;
        }

        /* Result Styles */
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .low-anxiety {
            border-left: 5px solid #28a745;
        }

        .moderate-anxiety {
            border-left: 5px solid #ffc107;
        }

        .high-anxiety {
            border-left: 5px solid #dc3545;
        }

        .breathing-circle {
            width: 100px;
            height: 100px;
            background: #a5d6a7;
            border-radius: 50%;
            margin: 20px auto;
            animation: breathe 4s infinite ease-in-out;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }
        }
    </style>
</head>

<body>

    <div class="chat-container">
        <div class="chat-header">
            <h3 id="app-title">AnxietyScreen</h3>
            <button class="lang-switch" onclick="toggleLanguage()">EN / BN</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will appear here -->
        </div>
        <div class="input-area" id="input-area">
            <!-- Options will appear here -->
        </div>
    </div>

    <script>
        // --- Data & Config ---
        let currentLang = 'bn'; // Default to Bengali as per PRD
        let currentStep = 0;
        let answers = {};
        let startTime = Date.now();

        const questions = [
            { id: 'q1', text: { en: "Over the last 2 weeks, how often have you been feeling nervous, anxious, or on edge?", bn: "গত দুই সপ্তাহে, আপনি কতবার নার্ভাস, উদ্বিগ্ন বা সীমায় অনুভব করেছেন?" } },
            { id: 'q2', text: { en: "Not being able to stop or control worrying?", bn: "গত দুই সপ্তাহে, আপনি কতবার চিন্তা নিয়ন্ত্রণ বা বন্ধ করতে অক্ষম ছিলেন?" } },
            { id: 'q3', text: { en: "Worrying too much about different things?", bn: "গত দুই সপ্তাহে, আপনি কতবার বিভিন্ন বিষয় নিয়ে খুব বেশি চিন্তা করেছেন?" } },
            { id: 'q4', text: { en: "Trouble relaxing?", bn: "গত দুই সপ্তাহে, আপনি কতবার শান্ত হতে সমস্যা হয়েছে?" } },
            { id: 'q5', text: { en: "Being so restless that it is hard to sit still?", bn: "গত দুই সপ্তাহে, আপনি কতবার এত অস্থির ছিলেন যে স্থির থাকা কঠিন ছিল?" } },
            { id: 'q6', text: { en: "Becoming easily annoyed or irritable?", bn: "গত দুই সপ্তাহে, আপনি কতবার সহজেই বিরক্ত বা খিটখিটে হয়েছেন?" } },
            { id: 'q7', text: { en: "Feeling afraid as if something awful might happen?", bn: "গত দুই সপ্তাহে, আপনি কতবার ভয়ানক কিছু ঘটতে পারে এই ভয় অনুভব করেছেন?" } }
        ];

        const options = [
            { value: 0, text: { en: "Not at all", bn: "একদম না" } },
            { value: 1, text: { en: "Several days", bn: "কয়েক দিন" } },
            { value: 2, text: { en: "More than half the days", bn: "অর্ধেকের বেশি দিন" } },
            { value: 3, text: { en: "Nearly every day", bn: "প্রায় প্রতিদিন" } }
        ];

        const uiText = {
            welcome: { en: "Hello! I'm here to help you check your stress levels. It's private and free.", bn: "হ্যালো! আমি আপনার মানসিক চাপ পরীক্ষা করতে সাহায্য করতে এখানে আছি। এটি সম্পূর্ণ গোপনীয় এবং বিনামূল্যে।" },
            startBtn: { en: "Start Check-up", bn: "পরীক্ষা শুরু করুন" },
            processing: { en: "Analyzing your answers...", bn: "আপনার উত্তর বিশ্লেষণ করা হচ্ছে..." },
            error: { en: "Something went wrong. Please try again.", bn: "কিছু ভুল হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।" },
            resultTitle: { en: "Your Result", bn: "আপনার ফলাফল" },
            low: { en: "Low Anxiety", bn: "কম উদ্বেগ" },
            moderate: { en: "Moderate Anxiety", bn: "মাঝারি উদ্বেগ" },
            high: { en: "High Anxiety", bn: "উচ্চ উদ্বেগ" },
            restart: { en: "Start Again", bn: "আবার শুরু করুন" }
        };

        // --- Core Functions ---

        function init() {
            // Check for saved state (Offline Grace)
            const savedState = localStorage.getItem('anxiety_state');
            if (savedState) {
                // Restore logic could go here, but for MVP we start fresh to ensure clean data
                localStorage.removeItem('anxiety_state');
            }

            addBotMessage(uiText.welcome[currentLang]);
            showOptions([{
                text: uiText.startBtn[currentLang],
                action: () => startSurvey()
            }]);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'bn' : 'en';
            document.getElementById('chat-messages').innerHTML = ''; // Clear chat
            currentStep = 0;
            answers = {};
            init();
        }

        function addBotMessage(text) {
            const div = document.createElement('div');
            div.className = 'message bot-message';
            div.textContent = text;
            document.getElementById('chat-messages').appendChild(div);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'message user-message';
            div.textContent = text;
            document.getElementById('chat-messages').appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function showOptions(opts) {
            const container = document.getElementById('input-area');
            container.innerHTML = '';
            const optsDiv = document.createElement('div');
            optsDiv.className = 'options-container';

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.text;
                btn.onclick = () => {
                    container.innerHTML = ''; // Clear options after click
                    opt.action();
                };
                optsDiv.appendChild(btn);
            });
            container.appendChild(optsDiv);
        }

        function startSurvey() {
            startTime = Date.now();
            askQuestion();
        }

        function askQuestion() {
            if (currentStep < questions.length) {
                const q = questions[currentStep];
                addBotMessage(q.text[currentLang]);

                const currentOptions = options.map(opt => ({
                    text: opt.text[currentLang],
                    action: () => handleAnswer(q.id, opt.value, opt.text[currentLang])
                }));

                showOptions(currentOptions);
            } else {
                finishSurvey();
            }
        }

        function handleAnswer(qId, value, text) {
            addUserMessage(text);
            answers[qId] = value;

            // Save progress locally
            localStorage.setItem('anxiety_state', JSON.stringify(answers));

            currentStep++;
            setTimeout(askQuestion, 500); // Small delay for natural feel
        }

        async function finishSurvey() {
            addBotMessage(uiText.processing[currentLang]);

            // Prepare payload
            const payload = {
                ...answers,
                response_time: Date.now() - startTime,
                // Mocking other features for now
                age: 16,
                gender: 1
            };

            try {
                const response = await fetch('/api/assess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                showResult(result);

            } catch (e) {
                console.error(e);
                addBotMessage(uiText.error[currentLang]);
                // Fallback logic for offline
                const score = Object.values(answers).reduce((a, b) => a + b, 0);
                let classification = 'Low';
                if (score >= 15) classification = 'High';
                else if (score >= 10) classification = 'Moderate';

                showResult({ classification, score });
            }
        }

        function showResult(data) {
            const cls = data.classification;
            let msg = '';
            let extraHtml = '';

            if (cls === 'Low') {
                msg = currentLang === 'en' ? "Great news! Your anxiety levels seem normal." : "ভালো খবর! আপনার উদ্বেগের মাত্রা স্বাভাবিক।";
                extraHtml = `<div class='result-card low-anxiety'><h3>${uiText.low[currentLang]}</h3><p>Keep up the good work!</p></div>`;
            } else if (cls === 'Moderate') {
                msg = currentLang === 'en' ? "You seem a bit stressed. Let's try a breathing exercise." : "আপনি কিছুটা চিন্তিত মনে হচ্ছেন। আসুন একটি শ্বাস-প্রশ্বাসের ব্যায়াম করি।";
                extraHtml = `
                <div class='result-card moderate-anxiety'>
                    <h3>${uiText.moderate[currentLang]}</h3>
                    <div class="breathing-circle"></div>
                    <p>${currentLang === 'en' ? "Breathe in... Breathe out..." : "শ্বাস নিন... শ্বাস ছাড়ুন..."}</p>
                </div>`;
            } else {
                msg = currentLang === 'en' ? "Your anxiety levels are high. Here are some doctors who can help." : "আপনার উদ্বেগের মাত্রা বেশি। এখানে কিছু ডাক্তার আছেন যারা সাহায্য করতে পারেন।";
                extraHtml = `<div class='result-card high-anxiety'><h3>${uiText.high[currentLang]}</h3><div id='doctor-list'>Loading doctors...</div></div>`;
                fetchDoctors();
            }

            addBotMessage(msg);
            const div = document.createElement('div');
            div.innerHTML = extraHtml;
            document.getElementById('chat-messages').appendChild(div);
            scrollToBottom();

            showOptions([{
                text: uiText.restart[currentLang],
                action: () => {
                    currentStep = 0;
                    answers = {};
                    document.getElementById('chat-messages').innerHTML = '';
                    init();
                }
            }]);
        }

        async function fetchDoctors() {
            try {
                const res = await fetch('/api/doctors');
                const doctors = await res.json();
                const listHtml = doctors.map(d => `<p><strong>${d.name}</strong><br>${d.specialization}<br>${d.phone}</p>`).join('');
                document.getElementById('doctor-list').innerHTML = listHtml;
            } catch (e) {
                document.getElementById('doctor-list').innerText = "Could not load doctors.";
            }
        }

        // Start
        init();

    </script>

</body>

</html>